---
import '../../styles/global.css';
import { getCollection } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
  const allMusic = await getCollection('music');
  const tracks = allMusic
    .filter(track => !track.data.draft)
    .sort((a, b) => a.data.order - b.data.order);

  return tracks.map((track, index) => ({
    params: { slug: track.slug },
    props: {
      track,
      prev: tracks[index - 1] || null,
      next: tracks[index + 1] || null,
    },
  }));
}

const { track, prev, next } = Astro.props;
const { Content } = await track.render();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{track.data.title} — 原创音乐</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <style>
      .track-page { font-family: 'EB Garamond', serif; }
      .track-page .cinzel { font-family: 'Cinzel', serif; }
      .track-page canvas { position: fixed; top: 0; left: 0; z-index: 0; }

      .track-page .grain {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0.05;
        pointer-events: none;
        z-index: 100;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      }

      /* Lyrics container - centered with glow effects */
      .lyrics-wrapper {
        position: relative;
        max-width: 600px;
        max-height: 50vh;
        overflow-y: auto;
        padding: 2rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.2) transparent;
      }
      .lyrics-wrapper::-webkit-scrollbar { width: 4px; }
      .lyrics-wrapper::-webkit-scrollbar-track { background: transparent; }
      .lyrics-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

      .lyrics-content {
        font-size: 1.5rem;
        line-height: 2;
        color: rgba(255,255,255,0.7);
        white-space: pre-line;
        text-align: center;
        transition: all 0.5s ease;
      }

      /* Base glow - always present, subtle */
      .lyrics-glow {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 60%;
        background: radial-gradient(ellipse, rgba(165,243,252,0.08) 0%, transparent 70%);
        pointer-events: none;
        opacity: 0.5;
        transition: opacity 0.8s ease;
        filter: blur(40px);
      }

      /* Playing state - pulse glow */
      .track-page.is-playing .lyrics-glow {
        opacity: 1;
        animation: pulseGlow 3s ease-in-out infinite;
      }
      .track-page.is-playing .lyrics-content {
        color: rgba(255,255,255,0.9);
        text-shadow: 0 0 30px rgba(165,243,252,0.3);
      }

      @keyframes pulseGlow {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      }

      /* Hover state - intensify glow */
      .lyrics-wrapper:hover .lyrics-glow {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.15);
        background: radial-gradient(ellipse, rgba(165,243,252,0.15) 0%, transparent 70%);
      }
      .lyrics-wrapper:hover .lyrics-content {
        color: rgba(255,255,255,0.95);
        text-shadow: 0 0 40px rgba(165,243,252,0.4);
      }

      /* Click ripple effect */
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(165,243,252,0.4) 0%, transparent 70%);
        transform: scale(0);
        animation: rippleExpand 0.8s ease-out forwards;
        pointer-events: none;
      }
      @keyframes rippleExpand {
        to { transform: scale(4); opacity: 0; }
      }

      /* Navigation arrows */
      .nav-arrow {
        opacity: 0.3;
        transition: all 0.4s ease;
      }
      .nav-arrow:hover {
        opacity: 1;
        letter-spacing: 0.1em;
      }

      /* Audio player styling */
      .audio-player {
        filter: invert(1) hue-rotate(180deg);
        opacity: 0.5;
        transition: opacity 0.3s;
      }
      .audio-player:hover { opacity: 0.8; }
    </style>
  </head>
  <body class="track-page bg-black text-white overflow-hidden m-0">
    <div class="grain"></div>

    <!-- Three.js background (simplified: just stars) -->
    <div id="canvas-container"></div>

    <!-- Main layout -->
    <div class="fixed inset-0 flex flex-col z-10 p-6 md:p-10">

      <!-- Top bar: Back + Title + Tags -->
      <header class="flex justify-between items-start mb-4">
        <a href="/music" class="text-white/40 hover:text-white/70 text-xs tracking-[0.3em] uppercase transition-colors">
          ← Archive
        </a>
        <div class="text-right max-w-xs">
          <div class="text-[10px] tracking-[0.5em] text-white/30 uppercase mb-1">
            Station {String(track.data.order).padStart(2, '0')}
          </div>
          <h1 class="cinzel text-xl md:text-2xl tracking-[0.15em] font-bold">{track.data.title}</h1>
          <div class="flex flex-wrap justify-end gap-2 mt-2">
            {track.data.tags.map((tag: string) => (
              <span class="text-[9px] tracking-[0.2em] text-white/30 uppercase">{tag}</span>
            ))}
          </div>
        </div>
      </header>

      <!-- Audio player (top area, small) -->
      <div class="flex justify-center mb-4">
        <audio
          id="audio-player"
          controls
          preload="metadata"
          class="audio-player w-full max-w-sm"
        >
          <source src={track.data.audio} type="audio/mpeg" />
        </audio>
      </div>

      <!-- Center: Lyrics with glow -->
      <main class="flex-1 flex items-center justify-center">
        <div class="lyrics-wrapper" id="lyrics-container">
          <div class="lyrics-glow"></div>
          <div class="lyrics-content">
            <Content />
          </div>
        </div>
      </main>

      <!-- Bottom: Prev / Next navigation -->
      <footer class="flex justify-between items-end pt-4">
        {prev ? (
          <a href={`/music/${prev.slug}`} class="nav-arrow flex flex-col items-start">
            <span class="text-[9px] tracking-[0.4em] uppercase text-white/40 mb-1">Previous</span>
            <span class="cinzel text-sm tracking-[0.1em]">← {prev.data.title}</span>
          </a>
        ) : <div></div>}

        {next ? (
          <a href={`/music/${next.slug}`} class="nav-arrow flex flex-col items-end">
            <span class="text-[9px] tracking-[0.4em] uppercase text-white/40 mb-1">Next</span>
            <span class="cinzel text-sm tracking-[0.1em]">{next.data.title} →</span>
          </a>
        ) : <div></div>}
      </footer>
    </div>

    <script is:inline>
      // Audio play state detection
      const audio = document.getElementById('audio-player');
      const body = document.body;

      audio.addEventListener('play', () => body.classList.add('is-playing'));
      audio.addEventListener('pause', () => body.classList.remove('is-playing'));
      audio.addEventListener('ended', () => body.classList.remove('is-playing'));

      // Click ripple effect on lyrics
      const lyricsContainer = document.getElementById('lyrics-container');
      lyricsContainer.addEventListener('click', (e) => {
        const rect = lyricsContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const ripple = document.createElement('div');
        ripple.className = 'ripple';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.style.width = '100px';
        ripple.style.height = '100px';
        ripple.style.marginLeft = '-50px';
        ripple.style.marginTop = '-50px';
        lyricsContainer.appendChild(ripple);

        setTimeout(() => ripple.remove(), 800);
      });

      // Simple starfield background
      (function() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Stars
        const starGeom = new THREE.BufferGeometry();
        const starCoords = [];
        for (let i = 0; i < 1500; i++) {
          starCoords.push(
            (Math.random() - 0.5) * 300,
            (Math.random() - 0.5) * 300,
            (Math.random() - 0.5) * 300
          );
        }
        starGeom.setAttribute('position', new THREE.Float32BufferAttribute(starCoords, 3));
        const stars = new THREE.Points(starGeom, new THREE.PointsMaterial({ color: 0xffffff, size: 0.4 }));
        scene.add(stars);

        // Central soft glow sphere
        const glowGeom = new THREE.SphereGeometry(8, 32, 32);
        const glowMat = new THREE.MeshBasicMaterial({ color: 0xa5f3fc, transparent: true, opacity: 0.03 });
        const glow = new THREE.Mesh(glowGeom, glowMat);
        scene.add(glow);

        function animate() {
          requestAnimationFrame(animate);
          stars.rotation.y += 0.0001;
          stars.rotation.x += 0.00005;
          glow.rotation.y += 0.001;
          renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      })();
    </script>
  </body>
</html>
