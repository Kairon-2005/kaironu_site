---
import '../../styles/global.css';
import { sql } from '@vercel/postgres';
export const prerender = false;

let letters = [];
let error = null;

try {
  const result = await sql`
    SELECT m.id, m.nickname, m.created_at, m.body, r.created_at as replied_at, r.reply_body
    FROM messages m
    LEFT JOIN replies r ON m.id = r.message_id AND r.published = true
    WHERE m.type = 'public' AND m.status = 'approved'
    ORDER BY m.created_at DESC
  `;
  letters = result.rows;
} catch (err) {
  error = err.message;
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Public Letters</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
  </head>
  <body class="bg-black text-white min-h-screen">
    <div class="container mx-auto px-8 py-16 max-w-4xl">
      <!-- Header -->
      <div class="mb-12">
        <div class="flex items-center space-x-4 mb-8">
          <a href="/" class="text-[#F5F2EA] hover:text-white transition-colors duration-300 text-lg">
            ← Home
          </a>
          <span class="text-[#F5F2EA]/50">•</span>
          <a href="/message" class="text-[#F5F2EA] hover:text-white transition-colors duration-300 text-lg">
            ← Message
          </a>
        </div>
        <h1 class="text-4xl font-light text-[#F5F2EA] font-serif italic mb-4">Public Letters</h1>
      </div>

      {error ? (
        <div class="text-red-400 text-sm">Error loading letters: {error}</div>
      ) : letters.length === 0 ? (
        <div class="text-[#F5F2EA]/70 text-center py-12">
          No letters yet.
        </div>
      ) : (
        <div class="space-y-6">
          {letters.map((letter) => {
            const excerpt = letter.body.length > 200 ? letter.body.substring(0, 200) + '...' : letter.body;
            const date = new Date(letter.created_at).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
            
            return (
              <div class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6 hover:border-[#F5F2EA]/60 transition-colors duration-300">
                <a href={`/message/letter/${letter.id}`} class="block group">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="text-[#F5F2EA] font-serif italic group-hover:text-white transition-colors duration-300">
                      {letter.nickname || 'Anonymous'}
                    </h3>
                    <time class="text-[#F5F2EA]/50 text-sm">{date}</time>
                  </div>
                  
                  <p class="text-[#F5F2EA]/80 leading-relaxed">{excerpt}</p>
                  
                  {letter.reply_body && (
                    <div class="mt-3 text-[#F5F2EA]/60 text-sm">
                      Has reply
                    </div>
                  )}
                </a>
              </div>
            );
          })}
        </div>
      )}
    </div>
  </body>
</html>
