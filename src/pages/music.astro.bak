---
import '../styles/global.css';
import { getCollection } from 'astro:content';

const allMusic = await getCollection('music');

// Filter out drafts and sort by order (ascending)
const tracks = allMusic
  .filter(track => !track.data.draft)
  .sort((a, b) => a.data.order - b.data.order);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>原创音乐 | Kairon</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <style>
      .music-page { font-family: 'EB Garamond', serif; }
      .music-page .cinzel { font-family: 'Cinzel', serif; }
      .music-page canvas { position: fixed; top: 0; left: 0; z-index: 0; }

      .music-page .grain {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0.06;
        pointer-events: none;
        z-index: 100;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      }

      .music-page .scanner {
        position: fixed;
        top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.03), transparent);
        animation: scan 8s infinite linear;
        pointer-events: none;
        z-index: 99;
      }
      @keyframes scan { 0% { left: -100%; } 100% { left: 200%; } }

      .music-page .overlay {
        position: fixed;
        z-index: 10;
        pointer-events: none;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 3rem;
      }

      .music-page .track-list { pointer-events: auto; max-width: 400px; }

      .music-page .track-item {
        cursor: pointer;
        padding: 1rem 0;
        transition: all 0.5s ease;
        opacity: 0.3;
        border-bottom: 1px solid rgba(255,255,255,0);
        display: block;
        text-decoration: none;
        color: inherit;
      }
      .music-page .track-item:hover {
        opacity: 1;
        padding-left: 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      .music-page .track-item.active {
        opacity: 1;
        padding-left: 2rem;
        color: #a5f3fc;
      }
    </style>
  </head>
  <body class="music-page bg-black text-white overflow-hidden m-0">
    <div class="grain"></div>
    <div class="scanner"></div>

    <div class="overlay">
      <header>
        <a href="/" class="pointer-events-auto text-white/40 hover:text-white/70 text-xs tracking-[0.3em] uppercase transition-colors inline-block mb-4">← Home</a>
        <h1 class="cinzel text-4xl tracking-[0.3em] font-bold">原创音乐</h1>
        <p class="text-xs tracking-[0.5em] text-white/40 mt-2 uppercase">Original Compositions</p>
      </header>

      <div class="flex justify-between items-end">
        <div class="track-list">
          {tracks.map((track, index) => (
            <a href={`/music/${track.slug}`} class="track-item" data-index={index}>
              <div class="text-[10px] tracking-[0.5em] mb-1 uppercase">Station {String(track.data.order).padStart(2, '0')}</div>
              <div class="cinzel text-2xl tracking-[0.2em]">{track.data.title}</div>
              <div class="text-xs tracking-[0.2em] text-white/30 mt-1">{track.data.tags.join(' · ')}</div>
            </a>
          ))}
          {tracks.length === 0 && (
            <p class="text-white/30 text-sm">No tracks yet.</p>
          )}
        </div>

        <div class="text-right pointer-events-auto">
          <div id="planet-info" class="cinzel text-sm tracking-[0.4em] mb-4 text-white/60">OBSERVING: THE CORE</div>
          <div class="h-px w-32 bg-white/20 ml-auto"></div>
        </div>
      </div>
    </div>

    <script is:inline>
      let scene, camera, renderer, planets = [], stars;
      const planetData = [
        { radius: 1.5, distance: 8, speed: 0.005, hasRing: true, color: 0xffffff, name: "STATION 01" },
        { radius: 0.8, distance: 14, speed: 0.003, hasRing: false, color: 0xcccccc, name: "STATION 02" },
        { radius: 2.2, distance: 22, speed: 0.002, hasRing: true, color: 0xeeeeee, name: "STATION 03" },
        { radius: 1.2, distance: 30, speed: 0.0015, hasRing: false, color: 0xdddddd, name: "STATION 04" }
      ];

      function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 20, 40);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1.5);
        scene.add(pointLight);

        const coreGeom = new THREE.IcosahedronGeometry(3, 2);
        const coreMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
        const core = new THREE.Mesh(coreGeom, coreMat);
        scene.add(core);

        const starGeom = new THREE.BufferGeometry();
        const starCoords = [];
        for (let i = 0; i < 2000; i++) {
          starCoords.push((Math.random() - 0.5) * 400, (Math.random() - 0.5) * 400, (Math.random() - 0.5) * 400);
        }
        starGeom.setAttribute('position', new THREE.Float32BufferAttribute(starCoords, 3));
        stars = new THREE.Points(starGeom, new THREE.PointsMaterial({ color: 0xffffff, size: 0.5 }));
        scene.add(stars);

        planetData.forEach((data, i) => {
          const group = new THREE.Group();
          const curve = new THREE.EllipseCurve(0, 0, data.distance, data.distance);
          const points = curve.getPoints(100);
          const orbitGeom = new THREE.BufferGeometry().setFromPoints(points);
          const orbitMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.1 });
          const orbit = new THREE.LineLoop(orbitGeom, orbitMat);
          orbit.rotation.x = Math.PI / 2;
          scene.add(orbit);

          const geom = new THREE.SphereGeometry(data.radius, 32, 32);
          const mat = new THREE.MeshPhongMaterial({ color: 0x000000, emissive: data.color, emissiveIntensity: 0.1, shininess: 100, wireframe: i % 2 === 0 });
          const mesh = new THREE.Mesh(geom, mat);

          if (data.hasRing) {
            const ringGeom = new THREE.TorusGeometry(data.radius * 1.8, 0.05, 2, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.3 });
            const ring = new THREE.Mesh(ringGeom, ringMat);
            ring.rotation.x = Math.PI / 2.5;
            mesh.add(ring);
          }

          group.add(mesh);
          scene.add(group);
          planets.push({ group, mesh, data, angle: Math.random() * Math.PI * 2 });
        });

        animate();
      }

      function animate() {
        requestAnimationFrame(animate);
        if (typeof TWEEN !== 'undefined') TWEEN.update();

        planets.forEach(p => {
          p.angle += p.data.speed;
          p.group.position.x = Math.cos(p.angle) * p.data.distance;
          p.group.position.z = Math.sin(p.angle) * p.data.distance;
          p.mesh.rotation.y += 0.01;
        });

        if (stars) stars.rotation.y += 0.0002;
        renderer.render(scene, camera);
      }

      document.querySelectorAll('.track-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
          const idx = parseInt(item.getAttribute('data-index'));
          if (planets[idx]) {
            const targetPlanet = planets[idx];
            document.querySelectorAll('.track-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            document.getElementById('planet-info').innerText = 'OBSERVING: ' + targetPlanet.data.name;

            const targetPos = {
              x: targetPlanet.group.position.x + 5,
              y: targetPlanet.group.position.y + 3,
              z: targetPlanet.group.position.z + 10
            };

            if (typeof TWEEN !== 'undefined') {
              new TWEEN.Tween(camera.position).to(targetPos, 1500).easing(TWEEN.Easing.Cubic.Out).start();
            }
          }
        });
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      init();
    </script>
  </body>
</html>
