---
import '../../styles/global.css';
export const prerender = false;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Admin Inbox</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
  </head>
  <body class="bg-black text-white min-h-screen">
    <!-- Login form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center">
      <div class="bg-black border border-[#F5F2EA] rounded-lg p-8 max-w-md w-full mx-4">
        <h1 class="text-2xl font-light text-[#F5F2EA] font-serif italic mb-6 text-center">Admin Login</h1>
        
        <div class="space-y-4">
          <div>
            <label class="block text-[#F5F2EA] text-sm mb-2">Username</label>
            <input type="text" id="username" 
                   class="w-full bg-transparent border border-[#F5F2EA] rounded px-4 py-3 text-[#F5F2EA] focus:outline-none focus:border-white transition-colors duration-300">
          </div>
          
          <div>
            <label class="block text-[#F5F2EA] text-sm mb-2">Password</label>
            <input type="password" id="password"
                   class="w-full bg-transparent border border-[#F5F2EA] rounded px-4 py-3 text-[#F5F2EA] focus:outline-none focus:border-white transition-colors duration-300">
          </div>
          
          <button id="loginBtn" type="button"
                  class="w-full bg-transparent border border-[#F5F2EA] text-[#F5F2EA] px-6 py-4 rounded hover:bg-[#F5F2EA] hover:text-black transition-all duration-300 font-serif italic">
            Login
          </button>
          
          <div id="loginError" class="hidden text-red-400 text-sm text-center"></div>
        </div>
        
        <div class="text-center mt-6">
          <a href="/" class="text-[#F5F2EA]/70 hover:text-[#F5F2EA] transition-colors duration-300 text-sm">
            ← Back to Home
          </a>
        </div>
      </div>
    </div>

    <!-- Admin interface -->
    <div id="adminInterface" class="hidden container mx-auto px-8 py-16 max-w-7xl">
      <!-- Header -->
      <div class="mb-12">
        <div class="flex justify-between items-center mb-8">
          <a href="/" class="text-[#F5F2EA] hover:text-white transition-colors duration-300 text-lg">
            ← Home
          </a>
          <button id="logoutBtn" class="text-[#F5F2EA]/70 hover:text-[#F5F2EA] transition-colors duration-300 text-sm">
            Logout
          </button>
        </div>
        <h1 class="text-4xl font-light text-[#F5F2EA] font-serif italic mb-4">Admin Inbox</h1>
      </div>

      <!-- Message detail view -->
      <div id="messageDetail" class="hidden space-y-8">
        <div class="flex items-center space-x-4">
          <button id="backToList" class="text-[#F5F2EA] hover:text-white transition-colors duration-300">
            ← Back to inbox
          </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Message content -->
          <div class="space-y-6">
            <div class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6">
              <div id="selectedMessageContent" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Admin controls -->
          <div class="space-y-6">
            <form id="updateForm" class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6 space-y-4">
              <h3 class="text-[#F5F2EA] text-lg font-serif mb-4">Update Message</h3>
              
              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Status</label>
                <select id="statusSelect" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA]">
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>

              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Reply</label>
                <textarea id="replyTextArea" rows="6" 
                          class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] resize-vertical"
                          placeholder="Write a reply..."></textarea>
              </div>

              <button type="submit" 
                      class="w-full bg-transparent border border-[#F5F2EA] text-[#F5F2EA] px-4 py-3 rounded hover:bg-[#F5F2EA] hover:text-black transition-all duration-300">
                Save Changes
              </button>

              <div id="saveStatus" class="hidden text-sm"></div>
            </form>

            <!-- Metadata -->
            <div id="messageMetadata" class="bg-black border border-[#F5F2EA]/20 rounded-lg p-4 text-xs">
              <!-- Metadata will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Message list view -->
      <div id="messageList" class="space-y-8">
        <!-- Filters -->
        <div class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6">
          <h2 class="text-[#F5F2EA] text-lg font-serif mb-4">Filters</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-[#F5F2EA] text-sm mb-2">Type</label>
              <select id="typeFilter" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                <option value="all">All</option>
                <option value="public">Public</option>
                <option value="treehole">Treehole</option>
                <option value="private">Private</option>
              </select>
            </div>
            
            <div>
              <label class="block text-[#F5F2EA] text-sm mb-2">Status</label>
              <select id="statusFilter" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                <option value="all">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            
            <div>
              <label class="block text-[#F5F2EA] text-sm mb-2">Wants Reply</label>
              <select id="wantsReplyFilter" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                <option value="all">All</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            
            <div>
              <label class="block text-[#F5F2EA] text-sm mb-2">Has Reply</label>
              <select id="hasReplyFilter" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                <option value="all">All</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          
          <button id="applyFiltersBtn" type="button" class="mt-4 bg-transparent border border-[#F5F2EA] text-[#F5F2EA] px-4 py-2 rounded hover:bg-[#F5F2EA] hover:text-black transition-all duration-300 text-sm">
            Apply Filters
          </button>
        </div>

        <!-- Messages table -->
        <div id="messagesTableContainer">
          <div class="text-[#F5F2EA]/70 text-center py-8">Loading messages...</div>
        </div>
      </div>
    </div>

    <script>
      let authHeaders = {};
      let currentMessages = [];
      let selectedMessage = null;

      // DOM elements
      const loginForm = document.getElementById('loginForm');
      const adminInterface = document.getElementById('adminInterface');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginError = document.getElementById('loginError');
      const username = document.getElementById('username');
      const password = document.getElementById('password');

      const messageList = document.getElementById('messageList');
      const messageDetail = document.getElementById('messageDetail');
      const backToList = document.getElementById('backToList');
      const updateForm = document.getElementById('updateForm');
      const saveStatus = document.getElementById('saveStatus');

      // Filter elements
      const typeFilter = document.getElementById('typeFilter');
      const statusFilter = document.getElementById('statusFilter');
      const wantsReplyFilter = document.getElementById('wantsReplyFilter');
      const hasReplyFilter = document.getElementById('hasReplyFilter');
      const applyFiltersBtn = document.getElementById('applyFiltersBtn');

      // Login
      async function login() {
        const user = username.value.trim();
        const pass = password.value.trim();
        
        if (!user || !pass) {
          showLoginError('Please enter username and password');
          return;
        }

        authHeaders = {
          'Authorization': `Basic ${btoa(user + ':' + pass)}`
        };

        try {
          // Test auth by fetching messages
          const response = await fetch('/api/admin/message/list', {
            headers: authHeaders
          });

          if (response.ok) {
            loginForm.classList.add('hidden');
            adminInterface.classList.remove('hidden');
            loadMessages();
          } else {
            showLoginError('Invalid credentials');
            authHeaders = {};
          }
        } catch (error) {
          showLoginError('Login failed');
          authHeaders = {};
        }
      }

      function showLoginError(message) {
        loginError.textContent = message;
        loginError.classList.remove('hidden');
        setTimeout(() => {
          loginError.classList.add('hidden');
        }, 3000);
      }

      function logout() {
        authHeaders = {};
        currentMessages = [];
        selectedMessage = null;
        adminInterface.classList.add('hidden');
        loginForm.classList.remove('hidden');
        username.value = '';
        password.value = '';
      }

      // Load messages with filters
      async function loadMessages() {
        const params = new URLSearchParams();
        if (typeFilter.value !== 'all') params.set('type', typeFilter.value);
        if (statusFilter.value !== 'all') params.set('status', statusFilter.value);
        if (wantsReplyFilter.value !== 'all') params.set('wants_reply', wantsReplyFilter.value);
        if (hasReplyFilter.value !== 'all') params.set('has_reply', hasReplyFilter.value);

        try {
          const response = await fetch(`/api/admin/message/list?${params}`, {
            headers: authHeaders
          });

          if (!response.ok) {
            throw new Error('Failed to load messages');
          }

          const result = await response.json();
          if (result.ok) {
            currentMessages = result.messages;
            renderMessagesTable();
          } else {
            throw new Error(result.error || 'Failed to load messages');
          }
        } catch (error) {
          document.getElementById('messagesTableContainer').innerHTML = `
            <div class="text-red-400 text-center py-8">Error: ${error.message}</div>
          `;
        }
      }

      function renderMessagesTable() {
        const container = document.getElementById('messagesTableContainer');
        
        if (currentMessages.length === 0) {
          container.innerHTML = `
            <div class="text-[#F5F2EA]/70 text-center py-8">No messages found.</div>
          `;
          return;
        }

        const table = `
          <div class="bg-black border border-[#F5F2EA]/30 rounded-lg overflow-hidden">
            <table class="w-full">
              <thead>
                <tr class="border-b border-[#F5F2EA]/20">
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Name</th>
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Type</th>
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Status</th>
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Reply</th>
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Date</th>
                  <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Preview</th>
                </tr>
              </thead>
              <tbody>
                ${currentMessages.map(message => `
                  <tr class="border-b border-[#F5F2EA]/10 hover:bg-[#F5F2EA]/5 transition-colors duration-300 cursor-pointer" data-message-id="${message.id}">
                    <td class="px-6 py-4 text-[#F5F2EA]">
                      ${message.nickname || 'Anonymous'}
                    </td>
                    <td class="px-6 py-4 text-[#F5F2EA]/80 text-sm">${message.type}</td>
                    <td class="px-6 py-4">
                      <span class="px-2 py-1 rounded text-xs ${
                        message.status === 'approved' ? 'bg-green-900/30 text-green-300' :
                        message.status === 'rejected' ? 'bg-red-900/30 text-red-300' :
                        'bg-yellow-900/30 text-yellow-300'
                      }">
                        ${message.status}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-[#F5F2EA]/80 text-sm">
                      ${message.reply_body ? '✓' : (message.wants_reply ? 'Pending' : 'None')}
                    </td>
                    <td class="px-6 py-4 text-[#F5F2EA]/60 text-sm">
                      ${new Date(message.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 text-[#F5F2EA]/70 text-sm max-w-xs">
                      <div class="truncate">${message.body}</div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        container.innerHTML = table;

        // Add click handlers for message rows
        container.querySelectorAll('tr[data-message-id]').forEach(row => {
          row.addEventListener('click', () => {
            const messageId = row.dataset.messageId;
            showMessageDetail(messageId);
          });
        });
      }

      function showMessageDetail(messageId) {
        selectedMessage = currentMessages.find(m => m.id === messageId);
        if (!selectedMessage) return;

        // Populate message content
        const contentHtml = `
          <div class="flex justify-between items-start">
            <h2 class="text-[#F5F2EA] text-xl font-serif">${selectedMessage.nickname || 'Anonymous'}</h2>
            <time class="text-[#F5F2EA]/50 text-sm">
              ${new Date(selectedMessage.created_at).toLocaleString()}
            </time>
          </div>
          
          <div class="flex flex-wrap gap-2 text-xs">
            <span class="px-2 py-1 bg-[#F5F2EA]/10 text-[#F5F2EA] rounded">
              ${selectedMessage.type}
            </span>
            ${selectedMessage.wants_reply ? '<span class="px-2 py-1 bg-[#F5F2EA]/10 text-[#F5F2EA] rounded">wants reply</span>' : ''}
            <span class="px-2 py-1 rounded ${
              selectedMessage.status === 'approved' ? 'bg-green-900/30 text-green-300' :
              selectedMessage.status === 'rejected' ? 'bg-red-900/30 text-red-300' :
              'bg-yellow-900/30 text-yellow-300'
            }">
              ${selectedMessage.status}
            </span>
          </div>
          
          <div class="text-[#F5F2EA] leading-relaxed whitespace-pre-wrap">
            ${selectedMessage.body}
          </div>
        `;

        document.getElementById('selectedMessageContent').innerHTML = contentHtml;

        // Populate form
        document.getElementById('statusSelect').value = selectedMessage.status;
        document.getElementById('replyTextArea').value = selectedMessage.reply_body || '';

        // Populate metadata
        const metadataHtml = `
          <h4 class="text-[#F5F2EA] mb-2">Metadata</h4>
          <div class="space-y-1 text-[#F5F2EA]/60">
            <div>ID: ${selectedMessage.id}</div>
            ${selectedMessage.email ? `<div>Email: ${selectedMessage.email}</div>` : ''}
            <div>IP Hash: ${selectedMessage.ip_hash || 'None'}</div>
            <div>User Agent: ${selectedMessage.user_agent || 'None'}</div>
            ${selectedMessage.reply_created_at ? `<div>Replied: ${new Date(selectedMessage.reply_created_at).toLocaleString()}</div>` : ''}
          </div>
        `;

        document.getElementById('messageMetadata').innerHTML = metadataHtml;

        // Show detail view
        messageList.classList.add('hidden');
        messageDetail.classList.remove('hidden');
      }

      function hideMessageDetail() {
        messageDetail.classList.add('hidden');
        messageList.classList.remove('hidden');
        selectedMessage = null;
      }

      async function updateMessage() {
        if (!selectedMessage) return;

        const data = {
          id: selectedMessage.id,
          status: document.getElementById('statusSelect').value,
          replyText: document.getElementById('replyTextArea').value
        };

        try {
          const response = await fetch('/api/admin/message/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...authHeaders
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.ok) {
            saveStatus.textContent = 'Changes saved successfully';
            saveStatus.className = 'text-green-400 text-sm';
            saveStatus.classList.remove('hidden');
            
            // Update local data
            const messageIndex = currentMessages.findIndex(m => m.id === selectedMessage.id);
            if (messageIndex !== -1) {
              currentMessages[messageIndex].status = data.status;
              currentMessages[messageIndex].reply_body = data.replyText;
              selectedMessage = currentMessages[messageIndex];
            }
            
            setTimeout(() => {
              saveStatus.classList.add('hidden');
            }, 3000);
          } else {
            throw new Error(result.error || 'Failed to save changes');
          }
        } catch (err) {
          saveStatus.textContent = `Error: ${err.message}`;
          saveStatus.className = 'text-red-400 text-sm';
          saveStatus.classList.remove('hidden');
        }
      }

      // Event listeners
      loginBtn.addEventListener('click', login);
      logoutBtn.addEventListener('click', logout);
      
      username.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') password.focus();
      });
      
      password.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') login();
      });
      
      backToList.addEventListener('click', hideMessageDetail);
      applyFiltersBtn.addEventListener('click', loadMessages);
      
      updateForm.addEventListener('submit', (e) => {
        e.preventDefault();
        updateMessage();
      });
    </script>
  </body>
</html>
      <div class="mb-12">
        <a href="/" class="inline-block mb-8 text-[#F5F2EA] hover:text-white transition-colors duration-300 text-lg">
          ← Home
        </a>
        <h1 class="text-4xl font-light text-[#F5F2EA] font-serif italic mb-4">Admin Inbox</h1>
      </div>

      {selectedMessage ? (
        <!-- Message detail view -->
        <div class="space-y-8">
          <div class="flex items-center space-x-4">
            <a href="/admin/inbox" class="text-[#F5F2EA] hover:text-white transition-colors duration-300">
              ← Back to inbox
            </a>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Message content -->
            <div class="space-y-6">
              <div class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6">
                <div class="space-y-4">
                  <div class="flex justify-between items-start">
                    <h2 class="text-[#F5F2EA] text-xl font-serif">{selectedMessage.display_name}</h2>
                    <time class="text-[#F5F2EA]/50 text-sm">
                      {new Date(selectedMessage.created_at).toLocaleString()}
                    </time>
                  </div>
                  
                  <div class="flex flex-wrap gap-2 text-xs">
                    <span class="px-2 py-1 bg-[#F5F2EA]/10 text-[#F5F2EA] rounded">
                      {selectedMessage.mode}
                    </span>
                    <span class="px-2 py-1 bg-[#F5F2EA]/10 text-[#F5F2EA] rounded">
                      {selectedMessage.reply_preference}
                    </span>
                    <span class={`px-2 py-1 rounded ${
                      selectedMessage.status === 'approved' ? 'bg-green-900/30 text-green-300' :
                      selectedMessage.status === 'rejected' ? 'bg-red-900/30 text-red-300' :
                      'bg-yellow-900/30 text-yellow-300'
                    }`}>
                      {selectedMessage.status}
                    </span>
                  </div>
                  
                  <div class="text-[#F5F2EA] leading-relaxed whitespace-pre-wrap">
                    {selectedMessage.body}
                  </div>
                </div>
              </div>
            </div>

            <!-- Admin controls -->
            <div class="space-y-6">
              <form id="updateForm" class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6 space-y-4">
                <h3 class="text-[#F5F2EA] text-lg font-serif mb-4">Update Message</h3>
                
                <div>
                  <label class="block text-[#F5F2EA] text-sm mb-2">Status</label>
                  <select name="status" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA]">
                    <option value="pending" {selectedMessage.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="approved" {selectedMessage.status === 'approved' ? 'selected' : ''}>Approved</option>
                    <option value="rejected" {selectedMessage.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                  </select>
                </div>

                <div>
                  <label class="block text-[#F5F2EA] text-sm mb-2">Reply</label>
                  <textarea name="replyText" rows="6" 
                            class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] resize-vertical"
                            placeholder="Write a reply...">{selectedMessage.reply_text || ''}</textarea>
                </div>

                <button type="submit" 
                        class="w-full bg-transparent border border-[#F5F2EA] text-[#F5F2EA] px-4 py-3 rounded hover:bg-[#F5F2EA] hover:text-black transition-all duration-300">
                  Save Changes
                </button>

                <div id="saveStatus" class="hidden text-sm"></div>
              </form>

              <!-- Metadata -->
              <div class="bg-black border border-[#F5F2EA]/20 rounded-lg p-4 text-xs">
                <h4 class="text-[#F5F2EA] mb-2">Metadata</h4>
                <div class="space-y-1 text-[#F5F2EA]/60">
                  <div>ID: {selectedMessage.id}</div>
                  <div>IP Hash: {selectedMessage.ip_hash || 'None'}</div>
                  <div>User Agent: {selectedMessage.user_agent || 'None'}</div>
                  {selectedMessage.replied_at && (
                    <div>Replied: {new Date(selectedMessage.replied_at).toLocaleString()}</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <!-- Message list view -->
        <div class="space-y-8">
          <!-- Filters -->
          <form method="get" class="bg-black border border-[#F5F2EA]/30 rounded-lg p-6">
            <h2 class="text-[#F5F2EA] text-lg font-serif mb-4">Filters</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Mode</label>
                <select name="mode" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                  <option value="all" {mode === 'all' ? 'selected' : ''}>All</option>
                  <option value="public" {mode === 'public' ? 'selected' : ''}>Public</option>
                  <option value="private" {mode === 'private' ? 'selected' : ''}>Private</option>
                </select>
              </div>
              
              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Status</label>
                <select name="status" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                  <option value="all" {status === 'all' ? 'selected' : ''}>All</option>
                  <option value="pending" {status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="approved" {status === 'approved' ? 'selected' : ''}>Approved</option>
                  <option value="rejected" {status === 'rejected' ? 'selected' : ''}>Rejected</option>
                </select>
              </div>
              
              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Reply Pref</label>
                <select name="reply_preference" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                  <option value="all" {replyPref === 'all' ? 'selected' : ''}>All</option>
                  <option value="none" {replyPref === 'none' ? 'selected' : ''}>None</option>
                  <option value="key" {replyPref === 'key' ? 'selected' : ''}>Key</option>
                </select>
              </div>
              
              <div>
                <label class="block text-[#F5F2EA] text-sm mb-2">Replied</label>
                <select name="replied" class="w-full bg-black border border-[#F5F2EA] rounded px-3 py-2 text-[#F5F2EA] text-sm">
                  <option value="all" {replied === 'all' ? 'selected' : ''}>All</option>
                  <option value="yes" {replied === 'yes' ? 'selected' : ''}>Yes</option>
                  <option value="no" {replied === 'no' ? 'selected' : ''}>No</option>
                </select>
              </div>
            </div>
            
            <button type="submit" class="mt-4 bg-transparent border border-[#F5F2EA] text-[#F5F2EA] px-4 py-2 rounded hover:bg-[#F5F2EA] hover:text-black transition-all duration-300 text-sm">
              Apply Filters
            </button>
          </form>

          <!-- Messages table -->
          {error ? (
            <div class="text-red-400 text-sm">Error: {error}</div>
          ) : messages.length === 0 ? (
            <div class="text-[#F5F2EA]/70 text-center py-8">No messages found.</div>
          ) : (
            <div class="bg-black border border-[#F5F2EA]/30 rounded-lg overflow-hidden">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-[#F5F2EA]/20">
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Name</th>
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Mode</th>
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Status</th>
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Reply</th>
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Date</th>
                    <th class="px-6 py-4 text-left text-[#F5F2EA] text-sm font-serif">Preview</th>
                  </tr>
                </thead>
                <tbody>
                  {messages.map((message) => (
                    <tr class="border-b border-[#F5F2EA]/10 hover:bg-[#F5F2EA]/5 transition-colors duration-300">
                      <td class="px-6 py-4">
                        <a href={`/admin/inbox?id=${message.id}`} class="text-[#F5F2EA] hover:text-white transition-colors duration-300">
                          {message.display_name}
                        </a>
                      </td>
                      <td class="px-6 py-4 text-[#F5F2EA]/80 text-sm">{message.mode}</td>
                      <td class="px-6 py-4">
                        <span class={`px-2 py-1 rounded text-xs ${
                          message.status === 'approved' ? 'bg-green-900/30 text-green-300' :
                          message.status === 'rejected' ? 'bg-red-900/30 text-red-300' :
                          'bg-yellow-900/30 text-yellow-300'
                        }`}>
                          {message.status}
                        </span>
                      </td>
                      <td class="px-6 py-4 text-[#F5F2EA]/80 text-sm">
                        {message.reply_text ? '✓' : message.reply_preference}
                      </td>
                      <td class="px-6 py-4 text-[#F5F2EA]/60 text-sm">
                        {new Date(message.created_at).toLocaleDateString()}
                      </td>
                      <td class="px-6 py-4 text-[#F5F2EA]/70 text-sm max-w-xs">
                        <div class="truncate">{message.body}</div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}
    </div>

    {selectedMessage && (
      <script define:vars={{ messageId: selectedMessage.id }}>
        const form = document.getElementById('updateForm');
        const saveStatus = document.getElementById('saveStatus');

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const data = {
            id: messageId,
            status: formData.get('status'),
            replyText: formData.get('replyText')
          };

          try {
            const response = await fetch('/api/admin/message/update', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.ok) {
              saveStatus.textContent = 'Changes saved successfully';
              saveStatus.className = 'text-green-400 text-sm';
              saveStatus.classList.remove('hidden');
              
              setTimeout(() => {
                saveStatus.classList.add('hidden');
              }, 3000);
            } else {
              throw new Error(result.error || 'Failed to save changes');
            }
          } catch (err) {
            saveStatus.textContent = `Error: ${err.message}`;
            saveStatus.className = 'text-red-400 text-sm';
            saveStatus.classList.remove('hidden');
          }
        });
      </script>
    )}
  </body>
</html>// Force rebuild Sun Jan 18 16:33:04 +08 2026
